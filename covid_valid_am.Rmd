---
title: "covid_valid_am"
author: "Alisa Morshneva"
date: "28/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message=FALSE,
                      error=FALSE,
                      warning=FALSE)
library(dplyr)
library(tidyr)
require(lubridate)
library(ggplot2)
library(stringr)
library(zoo)
```
## Read data
```{r}
transferuri_raw <- read.csv("data/transferuri_new.csv")
analysis_p <- read.csv("data/analize_planice_new.csv")
analysis_u <- read.csv("data/analize_urgenta_new.csv")
info_raw <- read.csv("data/total.csv")
```
## Parse data
```{r}
# Разделение колонок дата_время на отдельные колонки:
transferuri <-transferuri_raw %>% 
  separate(StartDate, c("StartDate", "StartTime"), sep = " ") %>%
  separate(EndDate, c("EndDate", "EndTime"), sep = " ")
# Перевод дат в формат, пригодный для вычисления дней:
transferuri$StartDate <- as.Date(as.character(transferuri$StartDate), format="%d/%m/%Y")
transferuri$EndDate <- as.Date(as.character(transferuri$EndDate), format="%d/%m/%Y")
# Дни с момента госпитализации и дни до исхода (добавляю 1, чтобы учесть день поступления и исключить возможность нулевых значений при исходе в день поступления)
transferuri$hospit_days <- transferuri$EndDate - transferuri$StartDate
hosp_days <- transferuri %>%                                       
  group_by(id) %>%                         
  summarise(hospit_days_total = sum(hospit_days)) 
transferuri <-  merge(transferuri, hosp_days, by="id")
transferuri$OutcomeDate <- transferuri$StartDate + transferuri$hospit_days_total 

transfer <- select(transferuri, c(id, StartDate, hospit_days_total, OutcomeDate))
transfer <- transfer[row.names(unique(transfer[,c("id", "hospit_days_total")])),]

colnames(analysis_p) <-  c("id", "AnalysisDate","analiza", "rezultat")
colnames(analysis_u) <- c("id", "AnalysisDate","analiza", "rezultat")

analysis <- rbind(analysis_p, analysis_u)
analysis$AnalysisDate <- as.Date(as.character(analysis$AnalysisDate), format="%d/%m/%Y")

colnames(info_raw)[5] <- "Age"
colnames(info_raw)[11] <- "Outcome"

info <- info_raw[,c("id", "Age", "sex", "cicode","Outcome")]
```
# Merge data
```{r}
data_long_raw <- merge(transfer, analysis, by=c("id"))
# Добавляем информацию по исходам
data_long_raw <- merge(data_long_raw, info, by=c("id"))
# Количество пациентов на старте
length(unique(data_long_raw$id))
```
# Filter rows
```{r}
# отбор пациентов, поступивших с диагнозом "ковид"
data_long <- filter(data_long_raw, cicode %in% c("J128", "J129", "J168", "J188", "J189", "J208", "B342", "B349", "B972"))
# удаление пациентов, переведенных в другое учреждение
data_long <- filter(data_long, Outcome != 'transfer inter-spitalicesc')
# перевод исходов (0 - externat, 1 - decedat)
data_long$Outcome <- as.factor(ifelse(substring(tolower(data_long$Outcome),1,1)=='e', 0, 1))

# Количество пациентов после фильтрации
length(unique(data_long$id))
```
```{r}
# Подготовка данных для перевода в длинный формат
data_long$rezultat <- gsub('[_><]', '', data_long$rezultat)
data_long$rezultat <- gsub('min', '', data_long$rezultat)
data_long$rezultat <- trimws(data_long$rezultat, which = c("both"), whitespace = "[ \t\r\n]")
data_long <- filter(data_long, !str_detect(rezultat, '[A-z+/]'))

data_long$rezultat <- as.numeric(as.character(data_long$rezultat))
table(is.na(data_long$rezultat))

head(data_long)
```
```{r}
# Правим названия и размерности
length(sort(unique(data_long$analiza)))
data_long_upd <- data_long
# D-Dimer
data_long_upd$analiza <- gsub('D-dimeri', 'D-Dimer', data_long_upd$analiza)
data_long_upd$rezultat <- ifelse(data_long_upd$analiza == 'D-Dimer', data_long_upd$rezultat * 1000, data_long_upd$rezultat)
#
data_long_upd$analiza <- ifelse(data_long_upd$analiza %in% c('Timpul de tromboplastina partial activa','TTPA-Timpul de tromboplastina partial active','Timpul de tromboplastina  partial active  (TTPA)') , "APTT", data_long_upd$analiza)
data_long_upd$analiza <- ifelse(data_long_upd$analiza %in% c('Glucose','Glucoza','Dozarea glucozei','Dozarea glucozei in sange') , "Glucose", data_long_upd$analiza)
data_long_upd$analiza <- ifelse(data_long_upd$analiza %in% c('Dozarea ureei','Ureea','Uree') , "Urea", data_long_upd$analiza)
data_long_upd$analiza <- ifelse(data_long_upd$analiza %in% c('Leucocites','Numaratoarea leucocitelor') , "WBC", data_long_upd$analiza)
#
data_long_upd$analiza <- tolower(data_long_upd$analiza)
data_long_upd$analiza <- gsub('  ', ' ', data_long_upd$analiza)
data_long_upd$analiza <- gsub(':', '', data_long_upd$analiza)
#data_long_upd$analiza <- gsub('-', '', data_long_upd$analiza, fixed = TRUE)
data_long_upd$analiza <- gsub('+', '', data_long_upd$analiza, fixed = TRUE)
data_long_upd$analiza <- gsub('ureea', 'uree', data_long_upd$analiza)
data_long_upd$analiza <- gsub('uree', 'urea', data_long_upd$analiza)
data_long_upd$analiza <- gsub('determinarea proteinei c-reactive', 'crp', data_long_upd$analiza) 
data_long_upd$analiza <- gsub('dozarea proteinei totale', 'protein_total', data_long_upd$analiza) 
data_long_upd$analiza <- gsub('total protein', 'protein_total', data_long_upd$analiza) 
data_long_upd$analiza <- gsub('dozarea hemoglobinei', 'hg', data_long_upd$analiza) 


data_long_upd$analiza <- gsub('singerare', 'sangerare', data_long_upd$analiza)
data_long_upd$analiza <- gsub('clor', 'cl', data_long_upd$analiza)
data_long_upd$analiza <- gsub('figrinogen', 'fibrinogen', data_long_upd$analiza, fixed=TRUE)
data_long_upd$analiza <- gsub('fibrinogenul', 'fibrinogen', data_long_upd$analiza, fixed=TRUE) 
data_long_upd$analiza <- gsub('ca2', 'calciu', data_long_upd$analiza, fixed=TRUE) 
data_long_upd$analiza <- gsub(' o (aslo)', 'o', data_long_upd$analiza, fixed=TRUE) 
data_long_upd$analiza <- gsub('densitatea', 'densitate', data_long_upd$analiza, fixed=TRUE) 
data_long_upd$analiza <- gsub('centriguare', 'centrifugare', data_long_upd$analiza, fixed=TRUE) 
data_long_upd$analiza <- trimws(data_long_upd$analiza, which = c("both"), whitespace = "[ \t\r\n]")
length(sort(unique(data_long_upd$analiza)))
#sort(unique(data_long_upd$analiza))

data_long_to_wide <- data_long_upd %>%
  group_by(id, StartDate, OutcomeDate, AnalysisDate, Outcome, analiza) %>% 
  dplyr::summarise(rezultat_med = median(rezultat, na.rm = TRUE))
```
# Get final data (To wide + locf)
```{r}
data_full <-  pivot_wider(data_long_to_wide, names_from = "analiza", values_from = "rezultat_med") %>%
  group_by(id) %>% arrange(id,AnalysisDate) %>%  mutate_all(funs(na.locf(., na.rm = FALSE)))

# Set formats and sort columns

data_full$DaysBfOutcome <- as.character(data_full$OutcomeDate - data_full$AnalysisDate)
data_full$DayOfHosp <- as.character(data_full$AnalysisDate - data_full$StartDate)
data_full$limphocite_perc <- (data_full$limfocite/100)*data_full$wbc
data_full <- select(data_full,-c(StartDate,OutcomeDate))

data_full$id <- as.factor(data_full$id)

data <- data_full %>% 
  select(sapply(., class) %>% .[order(match(., c('factor', 'date', 'character','integer')))] %>% names) %>%
  mutate(DaysBfOutcome = as.numeric(DaysBfOutcome)) %>%
  filter(DaysBfOutcome >= 0 & DaysBfOutcome < 21) %>%
  mutate(DaysBfOutcome = factor(DaysBfOutcome,
                                levels = 21:0,
                                labels = 21:0,
                                ordered = TRUE))

data
write.csv(data,file = "data_all_analyzes.csv")
```
```{r}
data_9 <- select(data, c(id, Outcome, DaysBfOutcome, DayOfHosp, AnalysisDate, 'd-dimer', urea, limphocite_perc, crp, protein_total, aptt, wbc, hg, glucose)) 
data_9
```

# Boxplots 
```{r}
ggplot(data %>% filter(`protein_total` < 200), aes(x = DaysBfOutcome, y = protein_total, fill = Outcome)) + 
  geom_boxplot()

ggplot(data, aes(x = DaysBfOutcome, y = `urea`, fill = Outcome)) + 
  geom_boxplot()

ggplot(data, aes(x = DaysBfOutcome, y = `d-dimer`, fill = Outcome)) + 
  geom_boxplot() + scale_y_log10()

ggplot(data, aes(x = DaysBfOutcome, y = `wbc`, fill = Outcome)) + 
  geom_boxplot() + scale_y_log10() 


ggplot(data, aes(x = DaysBfOutcome, y = limphocite_perc , fill = Outcome)) + 
  geom_boxplot() + ylim(0,10)

```


```{r}
score_9 <- data_9
score_9$score <- 0
score_9$score  <- ifelse(score_9$'d-dimer' > 2149 & !is.na(score_9$'d-dimer'), score_9$score + 4, score_9$score)
score_9$score  <- ifelse(score_9$urea > 11 & !is.na(score_9$urea), score_9$score + 5, score_9$score)
score_9$score  <- ifelse(score_9$limphocite_perc < 0.7 & !is.na(score_9$limphocite_perc), score_9$score + 3, score_9$score)
score_9$score  <- ifelse(score_9$crp > 146 & !is.na(score_9$crp), score_9$score + 3, score_9$score)
score_9$score  <- ifelse(score_9$protein_total < 61 & !is.na(score_9$protein_total), score_9$score + 6, score_9$score)
score_9$score  <- ifelse(score_9$aptt > 42 & !is.na(score_9$aptt), score_9$score + 4, score_9$score)
score_9$score  <- ifelse(score_9$wbc > 13.5 & !is.na(score_9$wbc), score_9$score + 4, score_9$score)
score_9$score  <- ifelse(score_9$hg < 115 & !is.na(score_9$hg), score_9$score + 3, score_9$score)
score_9$score  <- ifelse(score_9$glucose > 9 & !is.na(score_9$glucose), score_9$score + 4, score_9$score)
score_9
write.csv(data,file = "score_9.csv")
```
```{r}
p <- ggplot(score_9, aes(x = DaysBfOutcome, y = score, fill = Outcome)) + 
  geom_boxplot()
p


```
```{r}
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)

    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}

sum <- summarySE(score_9, measurevar="score", groupvars=c("DaysBfOutcome","Outcome"))

pd <- position_dodge(0.1) # move them .05 to the left and right

ggplot(sum, aes(x=DaysBfOutcome, y=score, colour=Outcome)) + 
    geom_errorbar(aes(ymin=score-ci, ymax=score+ci), width=.1, position=pd) +
    geom_line(position=pd) +
    geom_point(position=pd) + theme_bw()
```




